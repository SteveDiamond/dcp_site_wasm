<!DOCTYPE html>
<html>
<head>
  <title>DCP Analyzer</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <!-- Bootstrap and jQuery + plugins -->
  <script src="static/jquery-1.9.1.min.js"></script>
  <script src="static/jquery.cookie.js"></script>
  <script src="static/bootstrap/js/bootstrap.min.js"></script>
  <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">

  <!-- D3.js -->
  <script type="text/javascript" src="static/d3.v3/d3.v3.min.js"></script>

  <!-- Site wide js and CSS -->
  <link href="static/css/treeInteraction.css" rel="stylesheet">
  <script type="text/javascript" src="static/js/base.js"></script>
  
  <!-- Tree visualization scripts -->
  <script src="static/js/TreeConstants.js"></script>
  <script src="static/js/TreeConstructor.js"></script>
  <script src="static/js/TreeDisplay.js"></script>
  <script src="static/js/TreeLayout.js"></script>
  <script src="static/js/treeInteraction.js"></script>
  <script src="static/js/analyzer.js"></script>

  <!-- Pyodide for client-side Python -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <!-- Thumbnail -->
  <link rel="shortcut icon" href="static/images/convex.ico" />
</head>
<body>
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <ul class="nav">
        <!-- Button to trigger feedback modal -->
        <li>
          <div>
            <a role="button" class="btn btn-primary nav-leftmost" data-toggle="modal" data-target="#feedback">Feedback</a>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <div class="container-fluid below-nav">
    <div class="row-fluid">
      <nav>
        <ul class="nav nav-pills nav-stacked span1">
          <li><a href="index.html">Home</a></li>
          <li><a href="rules.html">Rules</a></li>
          <li><a href="functions.html">Functions</a></li>
          <li class="active"><a href="analyzer.html">Analyzer</a></li>
          <li><a href="quiz.html">Quiz</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>
      
      <div class="span10">
        <!-- Error placeholder for initialization messages -->
        <div id="errorPlaceholder"></div>
        
        <!-- Main content from base page -->
        <div class="row tree-div">
          <div class="span12" id="tree"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="feedbackLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h4 id="feedbackLabel">Let us know how to improve the site!</h4>
    </div>
    <div class="modal-body">
      <textarea class="feedback" rows="10"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      <button class="btn btn-primary feedback" data-dismiss="modal">Send Feedback</button>
    </div>
  </div>

    <script>
        // Initialize Pyodide and load the original DCP parser
        let pyodide = null;
        
        // Update TreeConstants for client-side paths
        TreeConstants.IMAGE_PREFIX = "static/images/";
        TreeConstants.PREAMBLE = [
            'variable x y z u v w',
            'parameter a b c',
            'parameter positive d e f'
        ];
        
        async function initPyodide() {
            // Show loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'alert alert-info';
            loadingMsg.innerHTML = '<strong>Loading...</strong> Initializing Python environment for DCP analysis...';
            document.getElementById('errorPlaceholder').appendChild(loadingMsg);
            
            try {
                console.log('Loading Pyodide...');
                pyodide = await loadPyodide();
                console.log('Pyodide loaded successfully');
                
                // Install ply using micropip
                console.log('Loading micropip...');
                await pyodide.loadPackage("micropip");
                console.log('Micropip loaded, installing ply...');
                const micropip = pyodide.pyimport("micropip");
                await micropip.install('ply');
                console.log('PLY installed successfully');
                
                // Copy the DCP parser files to Pyodide filesystem
                console.log('Setting up DCP parser files...');
                pyodide.runPython(`
import os
# Create directory structure in Pyodide
os.makedirs('dcp_parser', exist_ok=True)
os.makedirs('dcp_parser/atomic', exist_ok=True)  
os.makedirs('dcp_parser/error_messages', exist_ok=True)
os.makedirs('dcp_parser/expression', exist_ok=True)
os.makedirs('dcp_parser/json', exist_ok=True)
                `);
                
                // Load DCP parser files via HTTP (since they're in our project)
                const dcpFiles = [
                    'dcp_parser/__init__.py',
                    'dcp_parser/parser.py',
                    'dcp_parser/atomic/__init__.py',
                    'dcp_parser/atomic/atom_loader.py',
                    'dcp_parser/atomic/atoms.py',
                    'dcp_parser/atomic/monotonicity.py',
                    'dcp_parser/error_messages/__init__.py',
                    'dcp_parser/error_messages/composition_error.py',
                    'dcp_parser/error_messages/constraint_error.py',
                    'dcp_parser/error_messages/dcp_violation.py',
                    'dcp_parser/error_messages/dcp_violation_factory.py',
                    'dcp_parser/error_messages/operation_error.py',
                    'dcp_parser/error_messages/settings.py',
                    'dcp_parser/expression/__init__.py',
                    'dcp_parser/expression/constraints.py',
                    'dcp_parser/expression/curvature.py',
                    'dcp_parser/expression/expression.py',
                    'dcp_parser/expression/settings.py',
                    'dcp_parser/expression/sign.py',
                    'dcp_parser/expression/statement.py',
                    'dcp_parser/json/__init__.py',
                    'dcp_parser/json/constraint_encoder.py',
                    'dcp_parser/json/expression_encoder.py',
                    'dcp_parser/json/settings.py',
                    'dcp_parser/json/statement_encoder.py'
                ];
                
                // Load each file
                for (const filePath of dcpFiles) {
                    try {
                        console.log(`Loading ${filePath}...`);
                        const response = await fetch(filePath);
                        if (response.ok) {
                            const content = await response.text();
                            pyodide.FS.writeFile(filePath, content);
                        } else {
                            console.warn(`Could not load ${filePath}: ${response.status}`);
                        }
                    } catch (e) {
                        console.warn(`Error loading ${filePath}:`, e);
                    }
                }
                
                // Initialize the DCP parser
                console.log('Initializing DCP parser...');
                pyodide.runPython(`
import sys
import os

# Add dcp_parser to path
sys.path.insert(0, '/home/pyodide')

# Import the original DCP parser components
try:
    from dcp_parser.parser import Parser
    from dcp_parser.json.statement_encoder import StatementEncoder
    print("DCP parser imported successfully")
except Exception as e:
    print(f"Error importing DCP parser: {e}")
    # Fallback - we'll create a minimal parser
    class Parser:
        def __init__(self):
            self.statements = []
        def parse(self, text):
            # Simple fallback
            pass
    class StatementEncoder:
        def encode(self, expr):
            return '{"error": "DCP parser not available"}'

# Constants for preamble (from dcp_site views.py)
PREAMBLE = [
    'variable x y z u v w',
    'parameter a b c', 
    'parameter positive d e f'
]

def parse_expression_with_dcp(text):
    """Parse expression using the original DCP parser"""
    try:
        parser = Parser()
        
        # Load preamble (variables and parameters)  
        for line in PREAMBLE:
            parser.parse(line)
        
        # Parse the input expression
        parser.parse(text)
        
        if len(parser.statements) > 0:
            # Get the last statement (the expression we parsed)
            expression = parser.statements[-1]
            
            # Use the original JSON encoder to convert to dict
            encoder = StatementEncoder()
            json_str = encoder.encode(expression)
            
            # Parse the JSON string to get the dict
            import json
            result = json.loads(json_str)
            return result
        else:
            return {'error': 'No valid expression parsed'}
            
    except Exception as e:
        return {'error': str(e)}
                `);
                
                console.log('DCP parser loaded successfully');
                
                // Remove loading message
                document.getElementById('errorPlaceholder').innerHTML = '';
                
                // Override the parse function
                overrideParseFunction();
                console.log('Parse function overridden');
                console.log('Initialization complete');
                
                // Show the initial prompt tree
                showTreeFromUrl();
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('errorPlaceholder').innerHTML = 
                    '<div class="alert alert-danger"><strong>Error!</strong> Failed to initialize: ' + error + '</div>';
            }
        }
        
        function overrideParseFunction() {
            // Override TreeConstructor.parseObjective to use the original DCP parser
            TreeConstructor.parseObjective = function(objective, success_func, error_func) {
                try {
                    const result = pyodide.runPython(`
import json
result = parse_expression_with_dcp('''${objective}''')
json.dumps(result)
                    `);
                    
                    const parsed = JSON.parse(result);
                    console.log('Parse result:', parsed);
                    
                    if (parsed.error) {
                        console.error('Parse error:', parsed.error);
                        if (error_func) {
                            error_func({responseText: parsed.error}, 'error', parsed.error);
                        }
                    } else {
                        console.log('Parse success, calling success_func with:', parsed);
                        if (success_func) success_func(parsed);
                    }
                } catch (e) {
                    console.error('JavaScript error:', e);
                    if (error_func) {
                        error_func({responseText: e.toString()}, 'error', e.toString());
                    }
                }
            };
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initPyodide();
        });
    </script>
  </body>
</html>