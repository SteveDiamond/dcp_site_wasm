<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>DCP Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="static/dcp_sandbox/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="static/dcp_sandbox/css/treeInteraction.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      .tree-div {
        border-width: 4px;
        border-style: solid;
        border-color: #ddd;
      }
    </style>
    <link href="static/dcp_sandbox/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="static/dcp_sandbox/bootstrap/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="static/dcp_sandbox/bootstrap/img/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="static/dcp_sandbox/bootstrap/img/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="static/dcp_sandbox/bootstrap/img/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="static/dcp_sandbox/bootstrap/img/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="static/dcp_sandbox/images/convex.ico">
  </head>

  <body>

    <!-- Navigation -->
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/">DCP</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="/">Home</a></li>
              <li><a href="/rules">Rules</a></li>
              <li><a href="/functions">Functions</a></li>
              <li class="active"><a href="/analyzer">Analyzer</a></li>
              <li><a href="/quiz">Quiz</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Error placeholder for initialization messages -->
      <div id="errorPlaceholder"></div>
      
      <!-- Main content from base page -->
      <div class="row tree-div">
        <div class="span12" id="tree"></div>
      </div>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="static/dcp_sandbox/jquery-1.9.1.min.js"></script>
    <script src="static/dcp_sandbox/bootstrap/js/bootstrap.min.js"></script>
    <script src="static/dcp_sandbox/d3.v3/d3.v3.js"></script>
    <script src="static/dcp_sandbox/js/TreeConstants.js"></script>
    <script src="static/dcp_sandbox/js/TreeConstructor.js"></script>
    <script src="static/dcp_sandbox/js/TreeDisplay.js"></script>
    <script src="static/dcp_sandbox/js/base.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <script>
        // Initialize Pyodide and load the original DCP parser
        let pyodide = null;
        
        // Update TreeConstants for client-side paths
        TreeConstants.IMAGE_PREFIX = "static/dcp_sandbox/images/";
        TreeConstants.PREAMBLE = [
            'variable x y z u v w',
            'parameter a b c',
            'parameter positive d e f'
        ];
        
        async function initPyodide() {
            // Show loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'alert alert-info';
            loadingMsg.innerHTML = '<strong>Loading...</strong> Initializing Python environment for DCP analysis...';
            document.getElementById('errorPlaceholder').appendChild(loadingMsg);
            
            try {
                console.log('Loading Pyodide...');
                pyodide = await loadPyodide();
                console.log('Pyodide loaded successfully');
                
                // Install ply using micropip
                console.log('Loading micropip...');
                await pyodide.loadPackage("micropip");
                console.log('Micropip loaded, installing ply...');
                const micropip = pyodide.pyimport("micropip");
                await micropip.install('ply');
                console.log('PLY installed successfully');
                
                // Copy the DCP parser files to Pyodide filesystem
                console.log('Setting up DCP parser files...');
                pyodide.runPython(`
import os
# Create directory structure in Pyodide
os.makedirs('dcp_parser', exist_ok=True)
os.makedirs('dcp_parser/atomic', exist_ok=True)  
os.makedirs('dcp_parser/error_messages', exist_ok=True)
os.makedirs('dcp_parser/expression', exist_ok=True)
os.makedirs('dcp_parser/json', exist_ok=True)
                `);
                
                // Load DCP parser files via HTTP (since they're in our project)
                const dcpFiles = [
                    'dcp_parser/__init__.py',
                    'dcp_parser/parser.py',
                    'dcp_parser/atomic/__init__.py',
                    'dcp_parser/atomic/atom_loader.py',
                    'dcp_parser/atomic/atoms.py',
                    'dcp_parser/atomic/monotonicity.py',
                    'dcp_parser/error_messages/__init__.py',
                    'dcp_parser/error_messages/composition_error.py',
                    'dcp_parser/error_messages/constraint_error.py',
                    'dcp_parser/error_messages/dcp_violation.py',
                    'dcp_parser/error_messages/dcp_violation_factory.py',
                    'dcp_parser/error_messages/operation_error.py',
                    'dcp_parser/error_messages/settings.py',
                    'dcp_parser/expression/__init__.py',
                    'dcp_parser/expression/constraints.py',
                    'dcp_parser/expression/curvature.py',
                    'dcp_parser/expression/expression.py',
                    'dcp_parser/expression/settings.py',
                    'dcp_parser/expression/sign.py',
                    'dcp_parser/expression/statement.py',
                    'dcp_parser/json/__init__.py',
                    'dcp_parser/json/constraint_encoder.py',
                    'dcp_parser/json/expression_encoder.py',
                    'dcp_parser/json/settings.py',
                    'dcp_parser/json/statement_encoder.py'
                ];
                
                // Load each file
                for (const filePath of dcpFiles) {
                    try {
                        console.log(`Loading ${filePath}...`);
                        const response = await fetch(filePath);
                        if (response.ok) {
                            const content = await response.text();
                            pyodide.FS.writeFile(filePath, content);
                        } else {
                            console.warn(`Could not load ${filePath}: ${response.status}`);
                        }
                    } catch (e) {
                        console.warn(`Error loading ${filePath}:`, e);
                    }
                }
                
                // Initialize the DCP parser
                console.log('Initializing DCP parser...');
                pyodide.runPython(`
import sys
import os

# Add dcp_parser to path
sys.path.insert(0, '/home/pyodide')

# Import the original DCP parser components
try:
    from dcp_parser.parser import Parser
    from dcp_parser.json.statement_encoder import StatementEncoder
    print("DCP parser imported successfully")
except Exception as e:
    print(f"Error importing DCP parser: {e}")
    # Fallback - we'll create a minimal parser
    class Parser:
        def __init__(self):
            self.statements = []
        def parse(self, text):
            # Simple fallback
            pass
    class StatementEncoder:
        def encode(self, expr):
            return '{"error": "DCP parser not available"}'

# Constants for preamble (from dcp_site views.py)
PREAMBLE = [
    'variable x y z u v w',
    'parameter a b c', 
    'parameter positive d e f'
]

def parse_expression_with_dcp(text):
    """Parse expression using the original DCP parser"""
    try:
        parser = Parser()
        
        # Load preamble (variables and parameters)  
        for line in PREAMBLE:
            parser.parse(line)
        
        # Parse the input expression
        parser.parse(text)
        
        if len(parser.statements) > 0:
            # Get the last statement (the expression we parsed)
            expression = parser.statements[-1]
            
            # Use the original JSON encoder to convert to dict
            encoder = StatementEncoder()
            json_str = encoder.encode(expression)
            
            # Parse the JSON string to get the dict
            import json
            result = json.loads(json_str)
            return result
        else:
            return {'error': 'No valid expression parsed'}
            
    except Exception as e:
        return {'error': str(e)}
                `);
                
                console.log('DCP parser loaded successfully');
                
                // Remove loading message
                document.getElementById('errorPlaceholder').innerHTML = '';
                
                // Override the parse function
                overrideParseFunction();
                console.log('Parse function overridden');
                console.log('Initialization complete');
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('errorPlaceholder').innerHTML = 
                    '<div class="alert alert-danger"><strong>Error!</strong> Failed to initialize: ' + error + '</div>';
            }
        }
        
        function overrideParseFunction() {
            // Override TreeConstructor.parseObjective to use the original DCP parser
            TreeConstructor.parseObjective = function(objective, success_func, error_func) {
                try {
                    const result = pyodide.runPython(`
import json
result = parse_expression_with_dcp('''${objective}''')
json.dumps(result)
                    `);
                    
                    const parsed = JSON.parse(result);
                    console.log('Parse result:', parsed);
                    
                    if (parsed.error) {
                        console.error('Parse error:', parsed.error);
                        if (error_func) {
                            error_func({responseText: parsed.error}, 'error', parsed.error);
                        }
                    } else {
                        console.log('Parse success, calling success_func with:', parsed);
                        if (success_func) success_func(parsed);
                    }
                } catch (e) {
                    console.error('JavaScript error:', e);
                    if (error_func) {
                        error_func({responseText: e.toString()}, 'error', e.toString());
                    }
                }
            };
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initPyodide();
        });
    </script>
  </body>
</html>