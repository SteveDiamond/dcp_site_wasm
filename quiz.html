<!DOCTYPE html>
<html>
<head>
  <title>DCP Quiz</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <!-- Bootstrap and jQuery + plugins -->
  <script src="static/jquery-1.9.1.min.js"></script>
  <script src="static/jquery.cookie.js"></script>
  <script src="static/bootstrap/js/bootstrap.min.js"></script>
  <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">

  <!-- D3.js -->
  <script type="text/javascript" src="static/d3.v3/d3.v3.min.js"></script>

  <!-- MathJax -->
  <script type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
  </script>

  <!-- Site wide js and CSS -->
  <link href="static/css/treeInteraction.css" rel="stylesheet">
  <script type="text/javascript" src="static/js/base.js"></script>
  
  <!-- Tree visualization scripts -->
  <script src="static/js/TreeConstants.js"></script>
  <script src="static/js/TreeConstructor.js"></script>
  <script src="static/js/TreeLayout.js"></script>
  <script src="static/js/TreeDisplay.js"></script>
  <script src="static/js/treeInteraction.js"></script>

  <!-- Quiz scripts -->
  <script src="static/js/quiz-operators.js"></script>
  <script src="static/js/quiz-generator.js"></script>
  <script src="static/js/quiz.js"></script>

  <!-- Pyodide for client-side Python -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <!-- Thumbnail -->
  <link rel="shortcut icon" href="static/images/convex.ico" />
</head>
<body>
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <ul class="nav">
        <!-- Button to trigger feedback modal -->
        <li>
          <div>
            <a role="button" class="btn btn-primary nav-leftmost" data-toggle="modal" data-target="#feedback">Feedback</a>
          </div>
        </li>
        <li class="divider-vertical"></li>
        <li>
          <div><a href="#instructions" role="button" class="btn btn-primary" data-toggle="modal">Help</a></div>
        </li>
        <li class="divider-vertical"></li>
        <li>
          <button type="button" id="help" class="btn btn-primary">Hide Legends</button>
        </li>
        <li class="divider-vertical left-of-dropdown"></li>
        <li class="dropdown">
            <a id="difficulty" href="#" class="dropdown-toggle" data-toggle="dropdown">
              Difficulty
              <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li><a href="#Easy">Easy</a></li>
              <li><a href="#Medium">Medium</a></li>
              <li><a href="#Hard">Hard</a></li>
            </ul>
        </li>
        <li class="divider-vertical"></li>
      </ul>
    </div>
  </div>

  <div class="container-fluid below-nav">
    <div class="row-fluid">
      <nav>
        <ul class="nav nav-pills nav-stacked span1">
          <li><a href="index.html">Home</a></li>
          <li><a href="rules.html">Rules</a></li>
          <li><a href="functions.html">Functions</a></li>
          <li><a href="analyzer.html">Analyzer</a></li>
          <li class="active"><a href="quiz.html">Quiz</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>
      <div class="span11">
        <div id="errorPlaceholder"></div>
        <input type="hidden" id="csrf_token" value="dummy">
        <!--Body content-->
        <div id="tree"></div>
        
        <!-- Answer buttons -->
        <div class="row-fluid">
          <div class="span12 text-center">
            <div class="answers">
              Choose One: &nbsp
              <div class="btn-group">
                <button id="affine" type="button" class="btn btn-primary answer">Affine</button>
                <button id="convex" type="button" class="btn btn-primary answer">Convex</button>
                <button id="concave" type="button" class="btn btn-primary answer">Concave</button>
                <button id="non-convex" type="button" class="btn btn-primary answer">Non-DCP</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="feedbackLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h4 id="feedbackLabel">Let us know how to improve the site!</h4>
    </div>
    <div class="modal-body">
      <textarea class="feedback" rows="10"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      <button class="btn btn-primary feedback" data-dismiss="modal">Send Feedback</button>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instructions" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Instructions</h4>
        </div>
        <div class="modal-body">
          <p>Choose the button that matches the expression's curvature. The quiz difficulty will adjust to match your skill.</p>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>
    // Initialize Pyodide and quiz functionality
    let pyodide = null;
    
    // Update TreeConstants for client-side paths
    TreeConstants.IMAGE_PREFIX = "static/images/";
    TreeConstants.PREAMBLE = [
      'variable x y z u v w',
      'parameter a b c',
      'parameter positive d e f'
    ];
    
    async function initPyodide() {
        // Show loading message
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'alert alert-info';
        loadingMsg.innerHTML = '<strong>Loading...</strong> Initializing Python environment for DCP analysis...';
        document.getElementById('errorPlaceholder').appendChild(loadingMsg);
        
        try {
            console.log('Loading Pyodide...');
            pyodide = await loadPyodide();
            console.log('Pyodide loaded successfully');
            
            // Install ply using micropip
            console.log('Loading micropip...');
            await pyodide.loadPackage("micropip");
            console.log('Micropip loaded, installing ply...');
            const micropip = pyodide.pyimport("micropip");
            await micropip.install('ply');
            console.log('PLY installed successfully');
            
            // Load the full DCP parser
            console.log('Loading full DCP parser...');
            await loadDCPParser();
            console.log('DCP parser loaded successfully');
            
            // Override the AJAX parse function
            overrideParseFunction();
            console.log('Parse function overridden');
            
            // Remove loading message
            loadingMsg.remove();
            
            // Start the quiz
            console.log('Initialization complete - starting quiz');
            if (typeof startQuiz === 'function') {
                startQuiz();
            }
        } catch (error) {
            console.error('Initialization error:', error);
            loadingMsg.className = 'alert alert-error';
            loadingMsg.innerHTML = '<strong>Error!</strong> Failed to initialize: ' + error.message + '<br><small>Check browser console for details</small>';
        }
    }
    
    async function loadDCPParser() {
        // Load the full original DCP parser
        console.log('Loading full DCP parser...');
        
        // Copy the DCP parser files to Pyodide filesystem
        pyodide.runPython(`
import os
# Create directory structure in Pyodide
os.makedirs('dcp_parser', exist_ok=True)
os.makedirs('dcp_parser/atomic', exist_ok=True)  
os.makedirs('dcp_parser/error_messages', exist_ok=True)
os.makedirs('dcp_parser/expression', exist_ok=True)
os.makedirs('dcp_parser/json', exist_ok=True)
        `);
        
        // Load DCP parser files via HTTP (since they're in our project)
        const dcpFiles = [
            'dcp_parser/__init__.py',
            'dcp_parser/parser.py',
            'dcp_parser/atomic/__init__.py',
            'dcp_parser/atomic/atom_loader.py',
            'dcp_parser/atomic/atoms.py',
            'dcp_parser/atomic/monotonicity.py',
            'dcp_parser/error_messages/__init__.py',
            'dcp_parser/error_messages/composition_error.py',
            'dcp_parser/error_messages/constraint_error.py',
            'dcp_parser/error_messages/dcp_violation.py',
            'dcp_parser/error_messages/dcp_violation_factory.py',
            'dcp_parser/error_messages/operation_error.py',
            'dcp_parser/error_messages/settings.py',
            'dcp_parser/expression/__init__.py',
            'dcp_parser/expression/constraints.py',
            'dcp_parser/expression/curvature.py',
            'dcp_parser/expression/expression.py',
            'dcp_parser/expression/settings.py',
            'dcp_parser/expression/sign.py',
            'dcp_parser/expression/statement.py',
            'dcp_parser/json/__init__.py',
            'dcp_parser/json/constraint_encoder.py',
            'dcp_parser/json/expression_encoder.py',
            'dcp_parser/json/settings.py',
            'dcp_parser/json/statement_encoder.py'
        ];
        
        // Load each file
        for (const filePath of dcpFiles) {
            try {
                const response = await fetch(filePath);
                if (response.ok) {
                    const content = await response.text();
                    pyodide.FS.writeFile(filePath, content);
                }
            } catch (e) {
                console.warn(`Error loading ${filePath}:`, e);
            }
        }
        
        // Initialize the DCP parser
        pyodide.runPython(`
import sys
import os

# Add dcp_parser to path
sys.path.insert(0, '/home/pyodide')

# Import the original DCP parser components
from dcp_parser.parser import Parser
from dcp_parser.json.statement_encoder import StatementEncoder
print("Full DCP parser imported successfully for quiz")

# Constants for preamble (from dcp_site views.py)
PREAMBLE = [
    'variable x y z u v w',
    'parameter a b c', 
    'parameter positive d e f'
]

def parse_expression_with_dcp(text):
    """Parse expression using the original DCP parser"""
    try:
        parser = Parser()
        
        # Load preamble (variables and parameters)  
        for line in PREAMBLE:
            parser.parse(line)
        
        # Parse the input expression
        parser.parse(text)
        
        if len(parser.statements) > 0:
            # Get the last statement (the expression we parsed)
            expression = parser.statements[-1]
            
            # Use the original JSON encoder to convert to dict
            encoder = StatementEncoder()
            json_str = encoder.encode(expression)
            
            # Parse the JSON string to get the dict
            import json
            result = json.loads(json_str)
            return result
        else:
            return {'error': 'No valid expression parsed'}
            
    except Exception as e:
        return {'error': str(e)}
        `);
        console.log('DCP parser created successfully');
    }
    
    function overrideParseFunction() {
        // Override TreeConstructor.parseObjective to use Pyodide instead of server
        TreeConstructor.parseObjective = function(objective, success_func, error_func) {
            try {
                const result = pyodide.runPython(`
import json
result = parse_expression_with_dcp('''${objective}''')
json.dumps(result)
                `);
                
                const parsed = JSON.parse(result);
                if (parsed.error) {
                    if (error_func) {
                        error_func({responseText: parsed.error}, 'error', parsed.error);
                    }
                } else {
                    if (success_func) success_func(parsed);
                }
            } catch (e) {
                if (error_func) {
                    error_func({responseText: e.toString()}, 'error', e.toString());
                }
            }
        };
        
        // Also override the feedback function to show a message
        $('.btn.feedback').click(function() {
            alert('Feedback feature is not available in the client-side version.');
        });
    }
    
    // Initialize on page load
    $(document).ready(function() {
        initPyodide();
    });
  </script>
</body>
</html>