<!DOCTYPE html>
<html>
<head>
  <title>DCP Quiz</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <!-- Bootstrap and jQuery + plugins -->
  <script src="static/jquery-1.9.1.min.js"></script>
  <script src="static/jquery.cookie.js"></script>
  <script src="static/bootstrap/js/bootstrap.min.js"></script>
  <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">

  <!-- D3.js -->
  <script type="text/javascript" src="static/d3.v3/d3.v3.min.js"></script>

  <!-- MathJax -->
  <script type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
  </script>

  <!-- Site wide js and CSS -->
  <link href="static/css/treeInteraction.css" rel="stylesheet">
  <script type="text/javascript" src="static/js/base.js"></script>
  
  <!-- Tree visualization scripts -->
  <script src="static/js/TreeConstants.js"></script>
  <script src="static/js/TreeConstructor.js"></script>
  <script src="static/js/TreeLayout.js"></script>
  <script src="static/js/TreeDisplay.js"></script>
  <script src="static/js/treeInteraction.js"></script>

  <!-- Quiz scripts -->
  <script src="static/js/quiz-operators.js"></script>
  <script src="static/js/quiz-generator.js"></script>
  <script src="static/js/quiz.js"></script>

  <!-- Pyodide for client-side Python -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

  <!-- Thumbnail -->
  <link rel="shortcut icon" href="static/images/convex.ico" />
</head>
<body>
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <ul class="nav">
        <!-- Button to trigger feedback modal -->
        <li>
          <div>
            <a role="button" class="btn btn-primary nav-leftmost" data-toggle="modal" data-target="#feedback">Feedback</a>
          </div>
        </li>
        <li class="divider-vertical"></li>
        <li>
          <div><a href="#instructions" role="button" class="btn btn-primary" data-toggle="modal">Help</a></div>
        </li>
        <li class="divider-vertical"></li>
        <li>
          <button type="button" id="help" class="btn btn-primary">Hide Legends</button>
        </li>
        <li class="divider-vertical left-of-dropdown"></li>
        <li class="dropdown">
            <a id="difficulty" href="#" class="dropdown-toggle" data-toggle="dropdown">
              Difficulty
              <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li><a href="#Easy">Easy</a></li>
              <li><a href="#Medium">Medium</a></li>
              <li><a href="#Hard">Hard</a></li>
            </ul>
        </li>
        <li class="divider-vertical"></li>
      </ul>
    </div>
  </div>

  <div class="container-fluid below-nav">
    <div class="row-fluid">
      <nav>
        <ul class="nav nav-pills nav-stacked span1">
          <li><a href="index.html">Home</a></li>
          <li><a href="rules.html">Rules</a></li>
          <li><a href="functions.html">Functions</a></li>
          <li><a href="analyzer.html">Analyzer</a></li>
          <li class="active"><a href="quiz.html">Quiz</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>
      <div class="span11">
        <div id="errorPlaceholder"></div>
        <input type="hidden" id="csrf_token" value="dummy">
        <!--Body content-->
        <div id="chart"></div>
        
        <!-- Answer buttons -->
        <div class="row-fluid">
          <div class="span12 text-center">
            <div class="answers">
              Choose One: &nbsp
              <div class="btn-group">
                <button id="affine" type="button" class="btn btn-primary answer">Affine</button>
                <button id="convex" type="button" class="btn btn-primary answer">Convex</button>
                <button id="concave" type="button" class="btn btn-primary answer">Concave</button>
                <button id="non-convex" type="button" class="btn btn-primary answer">Non-DCP</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="feedbackLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h4 id="feedbackLabel">Let us know how to improve the site!</h4>
    </div>
    <div class="modal-body">
      <textarea class="feedback" rows="10"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      <button class="btn btn-primary feedback" data-dismiss="modal">Send Feedback</button>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instructions" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Instructions</h4>
        </div>
        <div class="modal-body">
          <p>Choose the button that matches the expression's curvature. The quiz difficulty will adjust to match your skill.</p>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>
    // Initialize Pyodide and quiz functionality
    let pyodide = null;
    
    // Update TreeConstants for client-side paths
    TreeConstants.IMAGE_PREFIX = "static/images/";
    TreeConstants.PREAMBLE = [
      'variable x y z u v w',
      'parameter a b c',
      'parameter positive d e f'
    ];
    
    async function initPyodide() {
        // Show loading message
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'alert alert-info';
        loadingMsg.innerHTML = '<strong>Loading...</strong> Initializing Python environment for DCP analysis...';
        document.getElementById('errorPlaceholder').appendChild(loadingMsg);
        
        try {
            console.log('Loading Pyodide...');
            pyodide = await loadPyodide();
            console.log('Pyodide loaded successfully');
            
            // Install ply using micropip
            console.log('Loading micropip...');
            await pyodide.loadPackage("micropip");
            console.log('Micropip loaded, installing ply...');
            const micropip = pyodide.pyimport("micropip");
            await micropip.install('ply');
            console.log('PLY installed successfully');
            
            // Load the full DCP parser
            console.log('Loading full DCP parser...');
            await loadDCPParser();
            console.log('DCP parser loaded successfully');
            
            // Override the AJAX parse function
            overrideParseFunction();
            console.log('Parse function overridden');
            
            // Remove loading message
            loadingMsg.remove();
            
            // Start the quiz
            console.log('Initialization complete - starting quiz');
            if (typeof startQuiz === 'function') {
                startQuiz();
            }
        } catch (error) {
            console.error('Initialization error:', error);
            loadingMsg.className = 'alert alert-error';
            loadingMsg.innerHTML = '<strong>Error!</strong> Failed to initialize: ' + error.message + '<br><small>Check browser console for details</small>';
        }
    }
    
    async function loadDCPParser() {
        // Create the same parser as in analyzer.html
        console.log('Creating DCP parser for Pyodide...');
        pyodide.runPython(`
import json
import ply.yacc as yacc
import ply.lex as lex

# Disable PLY's module validation to work around Pyodide issues
import ply.lex
import ply.yacc
# Monkey-patch to disable problematic validation
original_validate = ply.lex.LexerReflect.validate_module
ply.lex.LexerReflect.validate_module = lambda self, module: None

# Token definitions
tokens = ['ID', 'INT', 'FLOAT', 'PLUS', 'MINUS', 'TIMES', 'DIVIDE', 
          'LPAREN', 'RPAREN', 'COMMA', 'EQUALS', 'LEQ', 'GEQ']

# Reserved words
reserved = {
    'variable': 'VARIABLE',
    'parameter': 'PARAMETER', 
    'positive': 'POSITIVE',
    'negative': 'NEGATIVE',
    'zero': 'ZERO',
    'unknown': 'UNKNOWN'
}

tokens += list(reserved.values())

# Token rules
t_PLUS = r'\\+'
t_MINUS = r'-'
t_TIMES = r'\\*'
t_DIVIDE = r'/'
t_EQUALS = r'=='
t_LEQ = r'<='
t_GEQ = r'>='
t_LPAREN = r'\\('
t_RPAREN = r'\\)'
t_COMMA = r','
t_ignore = ' \\t'

def t_FLOAT(t):
    r'\\d*\\.\\d+'
    t.value = float(t.value)
    return t

def t_INT(t):
    r'\\d+'
    t.value = int(t.value)
    return t

def t_ID(t):
    r'[a-zA-Z_][a-zA-Z_0-9]*'
    t.type = reserved.get(t.value, 'ID')
    return t

def t_newline(t):
    r'\\n+'
    t.lexer.lineno += len(t.value)

def t_error(t):
    print(f"Illegal character '{t.value[0]}'")
    t.lexer.skip(1)

# Build lexer - provide missing context
import sys
if not hasattr(sys.modules['__main__'], '__file__'):
    sys.modules['__main__'].__file__ = '<interactive>'
lexer = lex.lex(debug=False)

# Simple expression classes
class Expression:
    def __init__(self, name="", op=None):
        self.name = name
        self.short_name = name
        self.op = op
        self.subexpressions = []
        self.sign = "unknown"
        self.curvature = "unknown"
        
# Function properties
FUNC_PROPS = {
    'square': {'curvature': 'convex', 'sign': 'positive'},
    'sqrt': {'curvature': 'concave', 'sign': 'positive'}, 
    'abs': {'curvature': 'convex', 'sign': 'positive'},
    'exp': {'curvature': 'convex', 'sign': 'positive'},
    'log': {'curvature': 'concave', 'sign': 'unknown'},
    'max': {'curvature': 'convex', 'sign': 'unknown'},
    'min': {'curvature': 'concave', 'sign': 'unknown'},
    'pos': {'curvature': 'convex', 'sign': 'positive'},
    'entr': {'curvature': 'concave', 'sign': 'unknown'},
    'geo_mean': {'curvature': 'concave', 'sign': 'positive'},
    'huber': {'curvature': 'convex', 'sign': 'positive'},
    'inv_pos': {'curvature': 'convex', 'sign': 'positive'},
    'kl_div': {'curvature': 'convex', 'sign': 'positive'},
    'log_sum_exp': {'curvature': 'convex', 'sign': 'unknown'},
    'norm1': {'curvature': 'convex', 'sign': 'positive'},
    'norm2': {'curvature': 'convex', 'sign': 'positive'},
    'norm_inf': {'curvature': 'convex', 'sign': 'positive'},
    'quad_over_lin': {'curvature': 'convex', 'sign': 'positive'}
}

# Parser state
symbols = {}
statements = []

# Grammar rules
def p_statement_expr(p):
    '''statement : expression'''
    statements.append(p[1])

def p_expression_func(p):
    '''expression : ID LPAREN expression RPAREN
                 | ID LPAREN expression COMMA expression RPAREN'''
    expr = Expression(p[1])
    if p[1] in FUNC_PROPS:
        expr.curvature = FUNC_PROPS[p[1]]['curvature']
        expr.sign = FUNC_PROPS[p[1]]['sign']
    if len(p) == 5:  # single argument
        expr.subexpressions = [p[3]]
    else:  # two arguments
        expr.subexpressions = [p[3], p[5]]
    p[0] = expr

def p_expression_binop(p):
    '''expression : expression PLUS expression
                 | expression MINUS expression
                 | expression TIMES expression
                 | expression DIVIDE expression'''
    expr = Expression(p[2])
    expr.subexpressions = [p[1], p[3]]
    expr.curvature = "affine"
    p[0] = expr

def p_expression_group(p):
    '''expression : LPAREN expression RPAREN'''
    p[0] = p[2]

def p_expression_number(p):
    '''expression : INT
                 | FLOAT'''
    expr = Expression(str(p[1]))
    expr.curvature = "constant"
    expr.sign = "positive" if p[1] >= 0 else "negative"
    p[0] = expr

def p_expression_id(p):
    '''expression : ID'''
    expr = Expression(p[1])
    expr.curvature = "affine"
    expr.sign = "unknown"
    p[0] = expr

def p_error(p):
    if p:
        raise Exception(f"Syntax error at token {p.type}")
    else:
        raise Exception("Syntax error at EOF")

# Build parser - provide the missing context PLY needs
import sys
sys.modules['__main__'].__file__ = '<interactive>'
parser = yacc.yacc(debug=False, write_tables=False)

def convert_to_dict(expr):
    """Convert expression to dict format expected by tree visualization"""
    if isinstance(expr, Expression):
        children = [convert_to_dict(se) for se in expr.subexpressions] if expr.subexpressions else None
        result = {
            'name': expr.name,
            'short_name': expr.short_name,
            'sign': expr.sign,
            'curvature': expr.curvature
        }
        if children:
            result['children'] = children
        return result
    else:
        return str(expr)

def parse_expression(text):
    global statements
    statements = []
    try:
        result = parser.parse(text, lexer=lexer)
        if statements:
            expr = statements[-1]
            return convert_to_dict(expr)
        return {'error': 'No valid expression'}
    except Exception as e:
        return {'error': str(e)}
        `);
        console.log('DCP parser created successfully');
    }
    
    function overrideParseFunction() {
        // Override TreeConstructor.parseObjective to use Pyodide instead of server
        TreeConstructor.parseObjective = function(objective, success_func, error_func) {
            try {
                const result = pyodide.runPython(`
import json
result = parse_expression('''${objective}''')
json.dumps(result)
                `);
                
                const parsed = JSON.parse(result);
                if (parsed.error) {
                    if (error_func) {
                        error_func({responseText: parsed.error}, 'error', parsed.error);
                    }
                } else {
                    if (success_func) success_func(parsed);
                }
            } catch (e) {
                if (error_func) {
                    error_func({responseText: e.toString()}, 'error', e.toString());
                }
            }
        };
        
        // Also override the feedback function to show a message
        $('.btn.feedback').click(function() {
            alert('Feedback feature is not available in the client-side version.');
        });
    }
    
    // Initialize on page load
    $(document).ready(function() {
        initPyodide();
    });
  </script>
</body>
</html>